<!DOCTYPE html>
<html lang="en-US" class="no-js no-svg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' id='parent-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-fonts-css'
        href='https://fonts.googleapis.com/css?family=Libre+Franklin%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C800%2C800i&#038;subset=latin%2Clatin-ext&#038;display=fallback'
        media='all' />
    <link rel='stylesheet' id='twentyseventeen-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen-child-cvonk/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-block-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/assets/css/blocks.css' media='all' />
    <link rel='stylesheet' id='fancybox-css'
        href='https://coertvonk.com/wp-content/plugins/easy-fancybox/css/jquery.fancybox.min.css' media='screen' />
    <style id='fancybox-inline-css'>
        #fancybox-content {
            border-color: #fff;
        }
    </style>
    <!-- MathJax 3.2 config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/cancel', '[tex]/physics']
            },
            tex: {
                packages: {
                    '[+]': ['cancel',]
                },
                macros: {
                    shaded: ["{\\bbox[5pt,background-color:##F7F7D2]{#1}}", 1],
                },
                tags: 'all',
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript">
        /* <![CDATA[ */
        document.querySelectorAll("ul.nav-menu").forEach(
            ulist => {
                if (ulist.querySelectorAll("li").length == 0) {
                    ulist.style.display = "none";

                }
            }
        );
        /* ]]> */
    </script>
    <style>
        div.flex-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        div.flex-container>* {
            flex-grow: 1;
            max-width: 80%;
        }

        div.flex-container.math>* {
            max-width: 100%;
        }

        div.flex-container.tight>* {
            flex-grow: unset;
            max-width: unset;
        }

        .mathtbl>tbody>tr>td {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
        }

        .mathtbl>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml>tbody>tr>td {
            text-align: center !important;
            border-collapse: collapse;
            border: 1px solid black;
            padding: 0px;
        }

        .mathtblsml>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml {
            font-size: 0.8em;
            margin: auto;
            border-spacing: 0px;
        }

        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }
        }

        .hp41-key {
            font-family: Verdana, Arial, "Times new roman";
            font-size: 10px;
            line-height: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0px 2px;
            color: #000000;
            border: #000000 1px solid;
            border-radius: 3px;
            background-color: #f8f8f8;
        }        
        table.error,
        table.decoded,
        table.partition {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.error tr > th,
        table.error tr > td,
        table.decoded tr > th,
        table.decoded tr > td,
        table.partition tr > th,
        table.partition th > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: wrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.error tr > th,
        table.decoded tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.error tr > *:nth-last-child(2),
        table.decoded tr > *:nth-last-child(2),
        table.partition tr > *:first-child {
            border-right: 1px solid black;
        }

        table.connections,
        table.partition {
            margin: 0 auto;
            margin-top: 1em;
        }
        table.bom {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.connections tr > th,
        table.connections tr > td,
        table.bom tr > th,
        table.bom tr > td,
        table.partition tr > th,
        table.partition tr > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.connections tr > td {
            text-align: center;
        }
        table.partition tr > td {
            text-align: left;
        }
        table.connections tr > th,
        table.bom tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.connections tr > .borderright,
        table.connections tr > *:nth-last-child(4),
        table.connections tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(3) {
            border-right: 1px solid black;
        }

    </style>
</head>

<body><div class="entry-content" style="margin: 40px">
<h1>Tools</h1>

<p>
    Describes the development environment for the OPNpool interface as described in <a href="https://github.com/cvonk/vscode-starters/tree/master/ESP32">VSCode-starters ESP32</a>, consisting of 
    <ul>        
        <li>GNU toolchain</li>
        <li>Espressif IoT Development Framework (ESP-IDF)</li>
        <li>Microsoft Visual Code Studio IDE</li>
        <li>Git version control</li>
    </ul>

    <div class="flex-container tight">
        <a href="https://coertvonk.com/wp-content/uploads/opnpool-tools-vscode.jpg"><img src="https://coertvonk.com/wp-content/uploads/opnpool-tools-vscode.jpg" alt="" width="500" class="alignnone size-full wp-image-32121" /></a>
    </div>
</p>

<h2>
    Git
</h2>
<p>
    We use <code>git</code> with a repository hosted on <a href="https://github.com/cvonk/ESP32_Pool-Interface">GitHub</a>.
</p>
<p>
    <ol>
        <li>
            Make sure that you can <code>ssh</code> to github.com.  On Windows, you may have to install the Windows <a href="https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse">OpenSSH Client</a>.
        </li>
        <li>
            Clone the repository and its submodules to a local directory.  Note the <b><code>--recursive</code></b> flag.

            [code toolbar="false" language="bash"]git clone --recursive git@github.com:cvonk/ESP32_Pool-Interface.git[/code]
        </li>
    </ol>
</p>

<h2>
    EAGLE
</h2>
<p>
    The schematics and layout of the printed circuit board are created using <a href="https://www.autodesk.com/education/free-software/eagle">Autodesk EAGLE</a>.  If you wish to edit them, you need to install this software.
</p>
<p>
    Remember
    <blockquote>
        Under Windows, specify the <code>EAGLE_HOME</code> environment variable that points to the your <code>EAGLE</code> directory. Inside EAGLE it is known as <code>$HOME</code> and is used in Control Panel » Options » Directories. 
    </blockquote>
</p>
<p>
    The schematic and board layout are available in the <code>hardware</code> directory. Custom parts such as the Wemos LOLIN-D32, DC/DC converter, JTAG, RS-485 connector can be found in the library at <code>hardware/libraries/OPNpool.lbr</code>.
</p>

<h2>
    ESP Tool Chain
</h2>
<p>
    These instructions are for Windows, the paths will be slightly different on other operating systems.
</p>
<p>
    Before you start, make sure that <a href="https://git-scm.com/">Git</a> is installed and that you can call <code>git</code> from the command line.
</p>
<p>
    If you haven't already, install <a href="https://code.visualstudio.com/">Microsoft Visual Studio Code</a> (VScode).
</p>
<p>
    From within VScode:
    <ol>
        <li>
            Add the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools">Microsoft's C/C++ extension</a>
        </li>
        <li>
            Add the Espressif IDF 1.4.0 extension.
        </li>
        <li>
            Install the tools and configure the Espressif IDF extension.
            <ul>
                <li>
                    <cspan class="hp41-key">F1</cspan> &raquo; <code>ISP-IDF: Configure ESP-IDF</code>
                </li>
                <li>
                    Select Advanced mode
                </li>
                <li>
                    ESP-IDF 4.4 in <code>C:/espressif</code> (goes to subdir <code>esp-idf</code>)
                </li>
                <li>
                    GNU Tools in <code>C:/espressif/bin</code>
                </li>
                <li>
                    Choose "Download ESP-IDF Tools"
                </li>
            </ul>
        </li>
        <li>
            To speed up compile times, disable Windows Defender's real-time scanning of <code>C:/espressif</code>. If you get hit with "You'll need a new app to open this windowsdefender link", then issue <code>Get-AppxPackage Microsoft.SecHealthUI -AllUsers | Reset-AppxPackage</code> from an elevated PowerShell terminal.
        </li>
    </ol>
</p>
<p>        
    If you prefer to use a ESP-IDF beta version or the master branch, refer to <a href="https://github.com/cvonk/vscode-starters/tree/master/ESP32">VSCode starter for ESP32</a>.
</p>

<h3>
    Start humble
</h3>
<p>
    <ol>
        <li>
            From Visual Studio Code, change to an empty folder and copy a simple example project such as <code>blink</code>.
            <ul>
                <li>
                    <cspan class="hp41-key">F1</cspan> » ESP-IDF: Show ESP-IDF Example Projects
                    <ul>
                        <li>
                            Get-started » Blink
                        </li>
                        <li>
                            Click on "Create project using example blink".
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li>
            Connect an ESP32 board to your computer. It will show up as a Serial Port in Windows device manager.
        </li>
        <li>
            Select the serial port in Visual Studio Code
            <ul>
                <li>
                    <cspan class="hp41-key">F1</cspan> » ESP-IDF: Device configuration
                    <ul>
                        <li>Device Target = ESP32</li>
                        <li>Device Port = COM4</li>
                        <li>Baud Rate = 115200</li>
                    </ul>
                </li>
            </ul>
        </li>
        <li>
            Start a compile-flash-monitor cycle
            <ol>
                <li>
                    <cspan class="hp41-key">F1</cspan> » ESP-IDF: Build, flash and monitor, or use <cspan class="hp41-key">^e</cspan> <cspan class="hp41-key">d</cspan>. 
                </li>
                <li>
                    Flash using the "UART".
                </li>
            </ol>
        </li>
    </ol>
</p>
<p>
    In case you encounter warnings or errors, refer to the table below.

    <div class="flex-container">
        <table class="error">
            <tr>
                <th>
                    Message
                </th>
                <th>
                    Explanation
                </th>
            </tr>
            <tr>
                <td>
                    <code>esptool.py failed with exit code 2</code>
                </td>
                <td>
                    Hints that the baud rate is to high. Try a different/shorter cable.
                </td>
            </tr>
            <tr>
                <td>
                    <code>no such option: -b</code>
                </td>
                <td>
                    Change <code>idf.py monitor</code> line in <code>.vscode\tasks.json</code> so that the command Monitor" is behind the options.
                </td>
            </tr>
            <tr>
                <td>
                    <code>CMake Error: Unable to open check cache file for write.</code> 
                </td>
                <td>
                    The directory for the cache file doesn't exist. Create it by hand.
                </td>
            </tr>
            <tr>
                <td>
                    <code>IDF_PATH environment variable is different from inferred IDF_PATH.</code>.
                </td>
                <td>
                    Likely because <code>$IDF_PATH</code> is not set in Windows' system/user environment. Ignore.
                </td>
            <tr>
                <td>
                    <code>Could NOT find Git (missing: GIT_EXECUTABLE)</code>
                </td>
                <td>
                    Odd because <code>${env:PATH}</code> does include <code>C:\Program Files\Git\cmd</code> [<a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/build-system.html">build system</a>]
                </td>
            </tr>
        </table>
    </div>
</p>

<h3>
    Compiling
</h3>
<p>
    You should now be able to compile and link e.g. the "factory" application.
</p>
<p>

    Start Visual Studio Code (vscode), in the directory <code>OPNpool\factory</code>.

    <ol>
        <li>
            Connect an ESP32 board to your computer. In Device Manager, the UART (COM) will show up under the Serial Ports. Select this port in Visual Studio Code:
            <ul>
                <li>
                    <cspan class="hp41-key">F1</cspan> » ESP-IDF: Device configuration
                    <ul>
                        <li>Device Target = ESP32</li>
                        <li>Device Port = COM6</li>
                        <li>Baud Rate = 115200</li>
                    </ul>
                </li>
            </ul>
        </li>
        <li>
            Start a compile-flash-monitor cycle
            <ol>
                <li>
                    <cspan class="hp41-key">F1</cspan> » ESP-IDF: Build, flash and monitor, or using <cspan class="hp41-key">^e</cspan> <cspan class="hp41-key">d</cspan>. 
                </li>
                <li>
                    Flash using the "UART".
                </li>
            </ol>
        </li>
    </ol>
</p>

<h2>
    Android Studio
</h2>
<p>
    The OPNpool provisioning application is available on the Play Store. The Deploying chapter of this document describes the process in more detail.
</p>
<p>
    If you prefer to build it yourself, download and install <a href="https://developer.android.com/studio/">Google Android Studio</a> and its SDK. Try to build one of the example projects before you embark on building the OPNpool provisioning app.
</p>

<h3>
    Build
</h3>
<p>
    Open Android Studio in the <code>android</code> directory and start the <code>build</code> process. Enable the Developer mode on you phone, and enable Wireless Debugging.  Your phone should now show up as a test device.  Click the button to run the app on your phone.
</p>
<p>
    Note that the app targets API 30 (Android 11), but builds with API 31.  This is so that we can request <code>BLUETOOTH_SCAN</code> and <code>BLUETOOTH_CONNECT</code> permissions for Android 12 devices. For details refer to the <a href="https://developer.android.com/about/versions/12/behavior-changes-all">Android 12 Behavior Changes document</a>
</p>
<p>
    <div class="continue-container no-print">
        <div class="continue-content">
            <div class="continue-text">
                Continue reading to learn about the <a href="https://coertvonk.com/sw/pool-interface/debugging-31963">debugging methods</a>.
        </div>
    </div>    
</p>

</div></body>
