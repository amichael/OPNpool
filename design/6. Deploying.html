<!DOCTYPE html>
<html lang="en-US" class="no-js no-svg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' id='parent-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-fonts-css'
        href='https://fonts.googleapis.com/css?family=Libre+Franklin%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C800%2C800i&#038;subset=latin%2Clatin-ext&#038;display=fallback'
        media='all' />
    <link rel='stylesheet' id='twentyseventeen-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen-child-cvonk/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-block-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/assets/css/blocks.css' media='all' />
    <link rel='stylesheet' id='fancybox-css'
        href='https://coertvonk.com/wp-content/plugins/easy-fancybox/css/jquery.fancybox.min.css' media='screen' />
    <style id='fancybox-inline-css'>
        #fancybox-content {
            border-color: #fff;
        }
    </style>
    <style>
        div.flex-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        div.flex-container>* {
            flex-grow: 1;
            max-width: 80%;
        }

        div.flex-container.math>* {
            max-width: 100%;
        }

        div.flex-container.tight>* {
            flex-grow: unset;
            max-width: unset;
        }

        .mathtbl>tbody>tr>td {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
        }

        .mathtbl>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml>tbody>tr>td {
            text-align: center !important;
            border-collapse: collapse;
            border: 1px solid black;
            padding: 0px;
        }

        .mathtblsml>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml {
            font-size: 0.8em;
            margin: auto;
            border-spacing: 0px;
        }

        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }
        }

        .hp41-key {
            font-family: Verdana, Arial, "Times new roman";
            font-size: 10px;
            line-height: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0px 2px;
            color: #000000;
            border: #000000 1px solid;
            border-radius: 3px;
            background-color: #f8f8f8;
        }        
        table.error,
        table.decoded,
        table.partition {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.error tr > th,
        table.error tr > td,
        table.decoded tr > th,
        table.decoded tr > td,
        table.partition tr > th,
        table.partition th > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: wrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.error tr > th,
        table.decoded tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.error tr > *:nth-last-child(2),
        table.decoded tr > *:nth-last-child(2),
        table.partition tr > *:first-child {
            border-right: 1px solid black;
        }

        table.connections,
        table.partition {
            margin: 0 auto;
            margin-top: 1em;
        }
        table.bom {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.connections tr > th,
        table.connections tr > td,
        table.bom tr > th,
        table.bom tr > td,
        table.partition tr > th,
        table.partition tr > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.connections tr > td {
            text-align: center;
        }
        table.partition tr > td {
            text-align: left;
        }
        table.connections tr > th,
        table.bom tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.connections tr > .borderright,
        table.connections tr > *:nth-last-child(4),
        table.connections tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(3) {
            border-right: 1px solid black;
        }

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shCore.min.css" integrity="sha512-q9B+BRcW0p2dRy94K1it1sy2Dv9UkAqIYoAUcWQY7Pis6fcQSAe5lohmJiymUL5glkr+Gu8fEVW6UjNKz6qm3A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shThemeEclipse.min.css" integrity="sha512-6CCQXim9WcRaWD9mGmchu6MVeR2hDl9loMnjzOP0ooiUuQQwa6u8FQL4v3socSg61fctsCqEiYIqXyHU/7A7ew==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shThemeDefault.min.css" integrity="sha512-lbsxQPIivlFg4R1HzWzroF+nQRivTblPWXEVKbbCbCeT+w9XJoC4B9cCpZQvcXxd0s8Nooe4YjbB7rYq5RoUkg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shCore.min.js" integrity="sha512-Z5dAQyvO8EyY1cHQcqYTYL8z6PDjM0URql6AioNodsSxxTJS5Fqfujr+o/4ye2dLp0he1qAVTiZABTunv6oLow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushCpp.min.js" integrity="sha512-rNtioul8Z7QMqn3HnQYDsdivIjCiS+J4dWlTzIA/hhJ7n3hWY3Zcpc5gPRvTLWVUVX2Og36JXELoWmU353t9Zw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushJScript.min.js" integrity="sha512-1sgIP38qm/y/33QFXdgSgBinVscLgnICy//6P5vVGaT/NyK2zZfsbLtrz/pPnix5CbEImM88s4HHxDFEHBcINg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPhp.min.js" integrity="sha512-K28WfzDb5L7eD+qiTCY0LAKXcPEeYEYdvxuKz1Yn2XNm28aXBxck3wbfYsM/EJDcXl62Aq68ZoN7zcYrbrRcpA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shAutoloader.min.js" integrity="sha512-fgB2B2iNPSMDR0e4sUBX9rVPhScqSJlamsQBhe+1CI+TbvoBL0N7hmlpOGwmO4gr5T0ho+JN0EP8J6JjzHuq/w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPowerShell.min.js" integrity="sha512-Nz643z7l3IUBhaSUHTgkBLxiU+GaIRMiqgUxDy2FjH0DIXEXb2u6QAV8OCZflMfROu+pg6ePw0Uvsemavsf3Ag==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        SyntaxHighlighter.all(); 
    </script>
    <style></style>
    <!-- MathJax 3.2 config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/cancel', '[tex]/physics']
            },
            tex: {
                packages: {
                    '[+]': ['cancel',]
                },
                macros: {
                    shaded: ["{\\bbox[5pt,background-color:##F7F7D2]{#1}}", 1],
                },
                tags: 'all',
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body><div class="entry-content" style="margin: 40px">
<h1>Deploying</h1>

<p>
    Rolling out a device to multiple sites introduces challenges.  The WiFi credentials can no longer be part of the source code. Applying firmware updates or accessing crash information over USB becomes cumbersome. Even simply finding the IP address of the device on the LAN may be challenging.
</p>
<p>
    To address such challenges we use a three tiered approach, in which the <code>factory</code> image decides what image to boot.
    <ol>
        <li>
            As usual, the <code>bootloader</code> image does some minimum initializations. If it finds a valid <code>ota</code> image, it passes control over to that image.  If not, it starts the <code>factory</code> image.
        </li>
        <li>
            The <code>factory</code> image takes care of provisioning WiFi and MQTT credentials with the help of a phone app. These credentials are stored in the <code>nvs</code> partition. It then downloads the <code>ota</code> image.
        </li>
        <li>
            We refer to the <code>ota</code> image as the <code>interface</code>, as it provides the core of the functionality of the OPNpool device.
        </li>
    </ol>
</p>
<p>
    To facilitate this the flash memory is partitioned as shown below.

    <p>
        The partition table is shown in the table below.
    
        <div class="flex-container tight">
            <figure>
                <table class="partition">
                    <tr>
                        <th>start</th>
                        <th>name</th>
                        <th>type</th>
                        <th>subtype</th>
                    </tr>
                    <tr>
                        <td>0x001000</td>
                        <td>bootloader</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>0x009000</td>
                        <td>nvs</td>
                        <td>data</td>
                        <td>nvs</td>
                    </tr>
                    <tr>
                        <td>0x00d000</td>
                        <td>otadata</td>
                        <td>data</td>
                        <td>ota</td>
                    </tr>
                    <tr>
                        <td>0x00f000</td>
                        <td>phy_init</td>
                        <td>data</td>
                        <td>phy</td>
                    </tr>
                    <tr>
                        <td>0x010000</td>
                        <td>factory</td>
                        <td>app</td>
                        <td>factory</td>
                    </tr>
                    <tr>
                        <td>0x160000</td>
                        <td>interface_0</td>
                        <td>app</td>
                        <td>ota_0</td>
                    </tr>
                    <tr>
                        <td>0x260000</td>
                        <td>interface_1</td>
                        <td>app</td>
                        <td>ota_1</td>
                    </tr>
                    </tbody>
                    <tr>
                        <td>0x360000</td>
                        <td>coredump</td>
                        <td>data</td>
                        <td>coredump</td>
                    </tr>
                </table>  
                <figcaption>
                    Partition table
                </figcaption>
            </figure>
        </div>
    </p> 
    </p>
<p>
    The following sections describes the process in further detail. A whole chapter is dedicated to the <code>interface</code> image, which provides the core functionality of the OPNpool device.
</p>

<h2>
    Bootloader image
</h2>
<p>
    A few more words on the <code>bootloader</code>:
    <ul>
        <li>
            If <code>otadata</code> partition is erased, it starts the <code>factory</code> image (assuming it is present).
        </li>
        <li>
            After the first OTA update, the <code>ota_data</code> partition is updated to specify which OTA app slot partition should be booted next.
        </li>
        <li>
            If the image works fine, it marks itself as <code>ESP_OTA_IMG_VALID</code> in the <code>ota_data</code>. Otherwise, it marks itself <code>ESP_OTA_IMG_INVALID</code>. This mechanism support image rollback to keep the device working after the update. It automatically rolls back to the previous version, if the image doesn't pass its self test.
        </li>
    </ul> 
</p>

<h2>
    Factory image
</h2>
<p>
    The <code>factory</code> image, handles the provisioning and triggers an over-the-air (OTA) download of the <code>interface</code> image. It then reboots, the <code>bootloader</code> will start the <code>interface</code> image.
</p>
<p>
    These steps are described in detail in the following section.
</p>

<h3>
    Provisioning WiFi credentials
</h3>
<p>
    For testing purposes, <code>WIFI_CONNECT_SSID</code>, <code>WIFI_CONNECT_PASSWORD</code> and <code>OPNPOOL_MQTT_URL</code> can also be provisioned using <code>Kconfig</code>. If empty, the device will use credentials from flash memory.
</p>
<p>
    A phone is used to connect to the <code>factory</code> app using Bluetooth Low Energy (BLE). The <code>factory</code> image will advertise itself to the phone app. Using this phone the user specifies the WiFi and MQTT credentials. During the process the phone remains in contact with the ESP while the WiFi is set up and connects to an access point. The WiFi and MQTT credentials are stored in the <code>nvs</code> partition of flash memory.
</p>
<p>
    You can find the source code of this app in the <code>android</code> directory. If you have an iOS phone, or you have problems running the Android app, you can extend <code>esp_prov.py</code> to include <code>mqtt_url</code> similar to what is shown <a href="https://github.com/espressif/esp-idf-provisioning-android/issues/11#issuecomment-586973381"">here</a>".
</p>
<p>
    The code base uses the git submodule <a href="https://github.com/cvonk/ESP32_factory-ble-prov"><code>ESP32_factory-ble-prov</code></a>.
</p>
<p>
    The figure and video below give an impression of the provisioning process

    <div class="flex-container tight">
        <figure>
            [code toolbar="false" language="plain"]I (907) factory: Starting BLE provisioning
I (1338) ble_prov: advertising as "POOL_CC4504"
I (99768) ble_prov_handler: Received WiFi credentials:
        ssid Guest Barn
        password xxxxxxxxxx
I (100098) ble_prov_handler: WiFi Credentials Applied
I (100288) ble_prov_handler: Connecting ..
I (104328) factory: IP addr 10.1.1.118
I (104328) ble_prov: STA Got IP
I (104328) ota_task: Checking for OTA update (http://coertvonk.com/cvonk/pool/interface.bin)
I (104338) ota_task: Running from part "factory" (0x00010000)
I (104548) ota_task: Writing part ota_0 at offset 0x160000
I (104548) ota_task: Firmware on server: interface.f6d8367-dirty (Mar  2 2022 10:26:42)
I (104548) ota_task: Firmware running:   factory.6bc4c65-dirty (Mar  2 2022 14:52:42)
W (104558) ota_task: Downloading OTA update ..
I (105848) ble_prov_handler: Connected state
I (109668) ota_task: Wrote 5% of 1280 kB
:[/code]
            <figcaption>
                Device debug
            </figcaption>            
        </figure>
        <figure>
            <div class="video-container">
                <video src="https://coertvonk.com/wp-content/uploads/OPNpool-provisioning.mp4" preload="auto" width="360" height="720"></video> 
            </div>
            <figcaption>
                Pool provisioning credentials
            </figcaption>
        </figure>
    </div>
</p>

<h3>
    Connecting to the WiFi network
</h3>
<p>
    To establish the WiFi connection, the code base uses the git submodule <a href="https://github.com/cvonk/ESP32_wifi-connect"><code>ESP32_wifi-connect</code></a>. This component makes this API available as a reusable component. It connects to a WiFi Access Point, and automatically reconnects when the connection drops.
</p>

<h3 id="ota">
    Download the Interface image
</h3>
<p>
    The <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ota.html">ESP-IDF API</a> provides a mechanism that allows a device to update itself based on data received while the normal firmware is running. Our code base uses the git submodule <a href="https://github.com/cvonk/ESP32_ota-update-task"><code>ESP32_ota-update-task</code></a> that makes the API available as a component.
</p>
<p>
    The location of the <code>factory</code> image is specified by <code>OTA_UPDATE_FIRMWARE_URL</code> in <code>Kconfig</code>.
    <details>
        <summary>
            Note on HTTPS
        </summary>
        <div style="margin-left: 2em; color: grey;">
            To use an HTTPS connections, you will need to add the server's public certificate to <code>components/ota_update_task/CMakelists.txt</code>, and uncomment some lines in <code>ota_update_task.c</code> with <code>server_cert_pem</code>.
        </div>
    </details>
</p>
<p>
    The code checks for an OTA update on a network server. If the image is different, it will download it. Upon completion, the device resets to activate the downloaded code. Note that we use the term "update" loosely, because it can also be used to downgrade the firmware.
</p>
<p>
    To determine if the currently running code is different as the code on the server, it compares the project name, version, date and time. Note that these are not always updated by the SDK. The best way to make sure they are updated is by committing your code to Git and building the project from scratch (by removing the <code>build</code> directory).
</p>
<p>
    During debugging, you may want to flash the <code>image</code> image directy as part of the "IDF-SDK: Build, flash and start monitor your device" cycle. To prevent that image from being overwritten by an OTA update, the update mechanism is disabled when the <code>interface</code> image is loaded in the factory partition.
</p>
<p>
    An example of the update process is shown in the figure below.

    <div class="flex-container">
        <figure>
            [code toolbar="false" language="plain"]I (3222) ota_task: Checking for OTA update (http://coertvonk.com/cvonk/pool/interface.bin)
    I (3232) ota_task: Running from part "factory" (0x00010000)
    I (3412) ota_task: Writing part ota_0 at offset 0x160000
I (3422) ota_task: Firmware on server: interface.f6d8367-dirty (Mar  2 2022 10:26:42)
I (3422) ota_task: Firmware running:   interface.6bc4c65 (Mar  2 2022 10:29:53)
W (3432) ota_task: Downloading OTA update ..
I (8142) ota_task: Wrote 5% of 1280 kB
:
I (23602) ota_task: Connection closed
I (24322) ota_task: Prepare to restart system![/code]
            <figcaption>
                OTA debug trace
            </figcaption>
        </figure>
    </div>
</p>
<p>
    More details of this component can be found at <a href="https://github.com/cvonk/ESP32_wifi-connect">Github</a>.   
</p>
<p>
    <div class="continue-container no-print">
        <div class="continue-content">
            <div class="continue-text">
                Continue reading to learn about the <a href="https://coertvonk.com/sw/embedded/pool-interface/interface-software-31967">interface software</a>.
            </div>
        </div>
    </div>    
</p>

</div></body>