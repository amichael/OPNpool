<!DOCTYPE html>
<html lang="en-US" class="no-js no-svg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' id='parent-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-fonts-css'
        href='https://fonts.googleapis.com/css?family=Libre+Franklin%3A300 300i 400 400i 600 600i 800 800i&#038;subset=latin latin-ext&#038;display=fallback'
        media='all' />
    <link rel='stylesheet' id='twentyseventeen-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen-child-cvonk/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-block-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/assets/css/blocks.css' media='all' />
    <link rel='stylesheet' id='fancybox-css'
        href='https://coertvonk.com/wp-content/plugins/easy-fancybox/css/jquery.fancybox.min.css' media='screen' />
    <style id='fancybox-inline-css'>
        #fancybox-content {
            border-color: #fff;
        }
    </style>
    <!-- MathJax 3.2 config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/cancel', '[tex]/physics']
            },
            tex: {
                packages: {
                    '[+]': ['cancel',]
                },
                macros: {
                    shaded: ["{\\bbox[5pt,background-color:##F7F7D2]{#1}}", 1],
                },
                tags: 'all',
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript">
        /* <![CDATA[ */
        document.querySelectorAll("ul.nav-menu").forEach(
            ulist => {
                if (ulist.querySelectorAll("li").length == 0) {
                    ulist.style.display = "none";

                }
            }
        );
        /* ]]> */
    </script>
    <style>
        div.flex-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        div.flex-container>* {
            flex-grow: 1;
            max-width: 80%;
        }

        div.flex-container.math>* {
            max-width: 100%;
        }

        div.flex-container.tight>* {
            flex-grow: unset;
            max-width: unset;
        }
        .admonition {
            clear: both;
            padding: 12px;
            line-height: 24px;
            margin-bottom: 24px;
            background: #e7f2fa;
        }
        .admonition-title:before {
            content: url("data:image/svg+xml,<%3fxml version='1.0' encoding='utf-8'%3f%3e <svg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 155.2 138.9' style='enable-background:new 0 0 155.2 138.9;' xml:space='preserve'%3e<style type='text/css'>.st0{fill:%236ab0de;}.st1{fill:white;}</style%3e<g%3e<path class='st1' d='M77.4 138.9c-9.2 0-18.3 0.1-27.5 0c-7.7-0.1-13.5-3.8-17.5-10.3C22.8 113 13.3 97.3 3.7 81.7c-4.9-8-5-16-0.2-24 C12.9 42.3 22.3 27 31.6 11.6C36.4 3.7 43.4 0 52.5 0C69.2 0 86 0 102.7 0c9.8 0 17 4.2 22 12.8c8.7 14.8 17.8 29.5 26.7 44.2 c5.2 8.5 5.1 16.8-0.1 25.3c-9.1 14.9-18.1 29.8-27.1 44.7c-4.5 7.5-10.8 11.8-19.7 11.9C95.5 138.9 86.4 138.9 77.4 138.9 C77.4 138.9 77.4 138.9 77.4 138.9z M85.2 54.9c0-5.7 0-11.3 0-17c0-5.2-3.2-8.4-8.1-8.3c-4.3 0.1-7.5 3.5-7.6 8.3 c-0.1 11.2-0.1 22.5 0 33.7c0 4.9 3.1 8.1 7.7 8.1c4.9 0 8-3.1 8-8C85.3 66 85.2 60.4 85.2 54.9z M87.7 99.6 c0-6.3-4.1-10.4-10.4-10.3c-5.5 0.1-10 4.6-10.1 10.1c-0.1 5.5 4.7 10.4 10.1 10.4C83.3 109.8 87.7 105.5 87.7 99.6z'/%3e<path class='st0' d='M85.2 54.9c0 5.6 0 11.1 0 16.7c0 5-3.1 8-8 8c-4.5 0-7.6-3.2-7.7-8.1c-0.1-11.2-0.1-22.5 0-33.7 c0-4.8 3.3-8.3 7.6-8.3c4.9-0.1 8.1 3.2 8.1 8.3C85.3 43.5 85.2 49.2 85.2 54.9z'/%3e<path class='st0' d='M87.7 99.6c0 6-4.4 10.2-10.4 10.2c-5.5-0.1-10.2-4.9-10.1-10.4c0.1-5.5 4.6-10 10.1-10.1 C83.6 89.2 87.7 93.3 87.7 99.6z'/%3e</g%3e</svg%3e");
            margin-right: 4px;
            display: inline-block;
            font-style: normal;
            font-weight: 400;
            line-height: 1;
            text-decoration: inherit;
            height: 1em;
            width: 1em;
            color: green;
        }
        .admonition-title {
            font-weight: 700;
            display: block;
            color: #fff;
            padding: 6px 12px;
            margin: -12px -12px 12px;
            background: #6ab0de;
        }

        .mathtbl>tbody>tr>td {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
        }

        .mathtbl>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml>tbody>tr>td {
            text-align: center !important;
            border-collapse: collapse;
            border: 1px solid black;
            padding: 0px;
        }

        .mathtblsml>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml {
            font-size: 0.8em;
            margin: auto;
            border-spacing: 0px;
        }

        @media print {
            .no-print,
            .no-print * {
                display: none !important;
            }
        }

        .hp41-key {
            font-family: Verdana, Arial, "Times new roman";
            font-size: 10px;
            line-height: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0px 2px;
            color: #000000;
            border: #000000 1px solid;
            border-radius: 3px;
            background-color: #f8f8f8;
        }        
        table.error,
        table.decoded,
        table.partition {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.error tr > th,
        table.error tr > td,
        table.decoded tr > th,
        table.decoded tr > td,
        table.partition tr > th,
        table.partition th > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: wrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.error tr > th,
        table.decoded tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.error tr > *:nth-last-child(2),
        table.decoded tr > *:nth-last-child(2),
        table.partition tr > *:first-child {
            border-right: 1px solid black;
        }

        table.connections,
        table.partition {
            margin: 0 auto;
            margin-top: 1em;
        }
        table.bom {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.connections tr > th,
        table.connections tr > td,
        table.bom tr > th,
        table.bom tr > td,
        table.partition tr > th,
        table.partition tr > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.connections tr > td {
            text-align: center;
        }
        table.partition tr > td {
            text-align: left;
        }
        table.connections tr > th,
        table.bom tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.connections tr > .borderright,
        table.connections tr > *:nth-last-child(4),
        table.connections tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(3) {
            border-right: 1px solid black;
        }

    </style>
</head>

<body><div class="entry-content" style="margin: 40px">
<h1>Home Automation</h1>

<p>
    <div class="admonition note">
        <p class="admonition-title">Note</p>
        <p>Before diving into the details, let me emphasize, that the key mechanism is MQTT. Most home automation systems support MQTT. Details about configuring MQTT for other systems than Home Assistant are given later in this chapter.</p>
    </div>
</p>
<p>
    We will focus on Home Assistant with an install base of over 100,000 user
    <blockquote>        
        An open source home automation that puts local control and privacy first. Powered by a worldwide community of tinkerers and DIY enthusiasts. Perfect to run on a Raspberry Pi or a local server.
    </blockquote>
</p>

<h2>
    Home Assistant
</h2>
<p>
    We auto populate the Home Assistant entities using MQTT Discovery. This enables us to use MQTT devices with only minimal configuration effort on the side of Home Assistant. A few of these messages are shown in the section MQTT device discovery of chapter Interface.
</p>
<p>
    Home Assistant supports will use the messages and automatically populate the entities shown below.
    
    <div class="flex-container tight shadow">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-1-5.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-1-5-473x1024.png" alt="" width="300" class="alignnone size-large wp-image-32156" /></a>
            <figcaption>
                Device entities on Home Assistant
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-2.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-2-511x1024.png" alt="" width="300" class="alignnone size-large wp-image-32157" /></a>
            <figcaption>
                Device entities on Home Assistant cont'd
            </figcaption>
        </figure>
    </div>
</p>

<h2>
    Dashboard
</h2>
<p>
    In the Home Assistant <code>configuration.yaml</code> we add some rules and template sensors as shown in <code>hassio/packages</code>.  This also includes some rules that we use for the PoolMath integration.
</p>
<p>
    The Lovelace dashboard tab includes several cards as shown below. The YAML code can be found in <code>hassio/lovelace</code>.
</p>

<h3>
    Idle
</h3>
<p>
    When the pump is not running, the cards shown below wil be visible.
    <div class="flex-container tight shadow" style="align-items: flex-start; gap: 10px 10px;">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-circuits-off.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-circuits-off.png" alt="" width="220" class="alignnone size-large wp-image-32163" /></a>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-system.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-system.png" alt="" width="220" class="alignnone size-full wp-image-32159" /></a>
        </figure>
        <figure style="align-self: flex-start;">
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-water-temperature.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-water-temperature.png" alt="" width="220" class="alignnone size-large wp-image-32161" /></a>
        </figure>
    </div>
</p>
<p>
    When for instance the pool circuit is activated, additional cards show up.
    <div class="flex-container tight shadow" style="align-items: flex-start; gap: 10px 10px;">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-circuits-pool-on.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-circuits-pool-on.png" alt="" width="220" class="alignnone size-large wp-image-32164" /></a>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-chlorinator.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-chlorinator.png" alt="" width="220" class="alignnone size-large wp-image-32162" /></a>
        </figure>
    </div>
    <div class="flex-container tight shadow" style="align-items: flex-start; gap: 10px 10px;">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-pool-thermostat.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-pool-thermostat.png" alt="" width="220" class="alignnone size-large wp-image-32165" /></a>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-pump.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hassio-lovelace-pump.png" alt="" width="220" class="alignnone size-large wp-image-32166" /></a>
        </figure>
    </div>
</p>

<h2>
    Other home automation systems
</h2>
<p>
    The OPNpool device publishes state transitions using MQTT. You find an overview of the topics in the table below.

    <table class="partition">
        <tr>
            <th>
                Topic
            </th>
            <th>
                Example value
            </th>
        </tr>
        <tr><td>homeassistant/switch/opnpool/pool_circuit/state</td>     <td>ON</td></tr>
        <tr><td>homeassistant/switch/opnpool/spa_circuit/state</td>      <td>OFF</td></tr>
        <tr><td>homeassistant/switch/opnpool/aux1_circuit/state</td>     <td>OFF</td></tr>
        <tr><td>homeassistant/switch/opnpool/aux2_circuit/state</td>     <td>OFF</td></tr>
        <tr><td>homeassistant/switch/opnpool/aux3_circuit/state</td>     <td>OFF</td></tr>
        <tr><td>homeassistant/switch/opnpool/ft1_circuit/state</td>      <td>OFF</td></tr>
        <tr><td>homeassistant/switch/opnpool/ft2_circuit/state</td>      <td>OFF</td></tr>
        <tr><td>homeassistant/switch/opnpool/ft3_circuit/state</td>      <td>OFF</td></tr>
        <tr><td>homeassistant/switch/opnpool/ft4_circuit/state</td>      <td>OFF</td></tr>
        <tr><td>homeassistant/climate/opnpool/pool_heater/available</td> <td>online</td></tr>
        <tr><td>homeassistant/climate/opnpool/pool_heater/state</td>
            <td>
                [code gutter="false" toolbar="off" tab-size="4" language="javascript"]{
    "mode": "heat",
    "heatsrc": "None", // None/Heater/SolarPref/Solar
    "target_temp": 70,
    "current_temp": 67,
    "action": "off"  // off/heating/idle
}[/code]
            </td>
        </tr>
        <tr><td>homeassistant/climate/opnpool/spa_heater/available</td>  <td>offline</td></tr>
        <tr><td>homeassistant/climate/opnpool/spa_heater/state</td>
            <td>
                [code gutter="false" toolbar="off" tab-size="4" language="javascript"]{
    "mode": "heat",
    "heatsrc": "None", // None/Heater/SolarPref/Solar
    "target_temp": 0,
    "current_temp": 67,
    "action": "off"  // off/heating/idle
}[/code]
            </td>
        </tr>
        <tr><td>homeassistant/sensor/opnpool/pool_sched/state</td>       <td>08:00 - 10:00</td></tr>
        <tr><td>homeassistant/sensor/opnpool/spa_sched/state</td>        <td>no sched</td></tr>
        <tr><td>homeassistant/sensor/opnpool/aux1_sched/state</td>       <td>no sched</td></tr>
        <tr><td>homeassistant/sensor/opnpool/aux2_sched/state</td>       <td>no sched</td></tr>
        <tr><td>homeassistant/sensor/opnpool/air_temp/state</td>         <td>69</td></tr>
        <tr><td>homeassistant/sensor/opnpool/water_temp/state</td>       <td>67</td></tr>
        <tr><td>homeassistant/sensor/opnpool/system_time/state</td>      <td>11:28</td></tr>
        <tr><td>homeassistant/sensor/opnpool/ctrl_version/state</td>     <td>v2.080</td></tr>
        <tr><td>homeassistant/sensor/opnpool/if_version/state</td>       <td>v1.2.4</td></tr>
        <tr><td>homeassistant/sensor/opnpool/pump_mode/state</td>        <td>FILTER</td></tr>
        <tr><td>homeassistant/sensor/opnpool/pump_status/state</td>      <td>OK</td></tr>
        <tr><td>homeassistant/sensor/opnpool/pump_power/state</td>       <td>606</td></tr>
        <tr><td>homeassistant/sensor/opnpool/pump_gpm/state</td>         <td>0</td></tr>
        <tr><td>homeassistant/sensor/opnpool/pump_speed/state</td>       <td>2250</td></tr>
        <tr><td>homeassistant/sensor/opnpool/pump_error/state</td>       <td>0</td></tr>
        <tr><td>homeassistant/sensor/opnpool/chlor_name/state</td>       <td>Intellichlor--40</td></tr>
        <tr><td>homeassistant/sensor/opnpool/chlor_pct/state</td>        <td>25</td></tr>
        <tr><td>homeassistant/sensor/opnpool/chlor_salt/state</td>       <td>3650</td></tr>
        <tr><td>homeassistant/sensor/opnpool/chlor_status/state</td>     <td>OK</td></tr>
        <tr><td>homeassistant/binary_sensor/opnpool/pump_running/state</td>       <td>ON</td></tr>
        <tr><td>homeassistant/binary_sensor/opnpool/mode_service/state</td>       <td>OFF</td></tr>
        <tr><td>homeassistant/binary_sensor/opnpool/mode_temp_inc/state</td> <td>OFF</td></tr>
        <tr><td>homeassistant/binary_sensor/opnpool/mode_freeze_prot/state</td>   <td>OFF</td></tr>
        <tr><td>homeassistant/binary_sensor/opnpool/mode_timeout/state</td>       <td>OFF</td></tr>
        <tr><td></td>  <td></td></tr>
        <tr><td></td>  <td></td></tr>
    </table>
</p>
<p>
    <div class="continue-container no-print">
        <div class="continue-content">
            <div class="continue-text">
                Continue reading to learn about other <a href="https://coertvonk.com/category/sw/embedded">Embbedded C projects</a>.
        </div>
    </div>    
</p>

</div></body>
