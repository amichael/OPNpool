<!DOCTYPE html>
<html lang="en-US" class="no-js no-svg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' id='parent-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-fonts-css'
        href='https://fonts.googleapis.com/css?family=Libre+Franklin%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C800%2C800i&#038;subset=latin%2Clatin-ext&#038;display=fallback'
        media='all' />
    <link rel='stylesheet' id='twentyseventeen-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen-child-cvonk/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-block-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/assets/css/blocks.css' media='all' />
    <link rel='stylesheet' id='fancybox-css'
        href='https://coertvonk.com/wp-content/plugins/easy-fancybox/css/jquery.fancybox.min.css' media='screen' />
    <style id='fancybox-inline-css'>
        #fancybox-content {
            border-color: #fff;
        }
    </style>
    <style>
        div.flex-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        div.flex-container>* {
            flex-grow: 1;
            max-width: 80%;
        }

        div.flex-container.math>* {
            max-width: 100%;
        }

        div.flex-container.tight>* {
            flex-grow: unset;
            max-width: unset;
        }

        .mathtbl>tbody>tr>td {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
        }

        .mathtbl>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml>tbody>tr>td {
            text-align: center !important;
            border-collapse: collapse;
            border: 1px solid black;
            padding: 0px;
        }

        .mathtblsml>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml {
            font-size: 0.8em;
            margin: auto;
            border-spacing: 0px;
        }

        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }
        }

        .hp41-key {
            font-family: Verdana, Arial, "Times new roman";
            font-size: 10px;
            line-height: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0px 2px;
            color: #000000;
            border: #000000 1px solid;
            border-radius: 3px;
            background-color: #f8f8f8;
        }        
        table.error,
        table.decoded,
        table.partition {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.error tr > th,
        table.error tr > td,
        table.decoded tr > th,
        table.decoded tr > td,
        table.partition tr > th,
        table.partition th > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: wrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.error tr > th,
        table.decoded tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.error tr > *:nth-last-child(2),
        table.decoded tr > *:nth-last-child(2),
        table.partition tr > *:first-child {
            border-right: 1px solid black;
        }

        table.connections,
        table.partition {
            margin: 0 auto;
            margin-top: 1em;
        }
        table.bom {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.connections tr > th,
        table.connections tr > td,
        table.bom tr > th,
        table.bom tr > td,
        table.partition tr > th,
        table.partition tr > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.connections tr > td {
            text-align: center;
        }
        table.partition tr > td {
            text-align: left;
        }
        table.connections tr > th,
        table.bom tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.connections tr > .borderright,
        table.connections tr > *:nth-last-child(4),
        table.connections tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(3) {
            border-right: 1px solid black;
        }

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shCore.min.css" integrity="sha512-q9B+BRcW0p2dRy94K1it1sy2Dv9UkAqIYoAUcWQY7Pis6fcQSAe5lohmJiymUL5glkr+Gu8fEVW6UjNKz6qm3A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shThemeEclipse.min.css" integrity="sha512-6CCQXim9WcRaWD9mGmchu6MVeR2hDl9loMnjzOP0ooiUuQQwa6u8FQL4v3socSg61fctsCqEiYIqXyHU/7A7ew==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shThemeDefault.min.css" integrity="sha512-lbsxQPIivlFg4R1HzWzroF+nQRivTblPWXEVKbbCbCeT+w9XJoC4B9cCpZQvcXxd0s8Nooe4YjbB7rYq5RoUkg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shCore.min.js" integrity="sha512-Z5dAQyvO8EyY1cHQcqYTYL8z6PDjM0URql6AioNodsSxxTJS5Fqfujr+o/4ye2dLp0he1qAVTiZABTunv6oLow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushCpp.min.js" integrity="sha512-rNtioul8Z7QMqn3HnQYDsdivIjCiS+J4dWlTzIA/hhJ7n3hWY3Zcpc5gPRvTLWVUVX2Og36JXELoWmU353t9Zw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushJScript.min.js" integrity="sha512-1sgIP38qm/y/33QFXdgSgBinVscLgnICy//6P5vVGaT/NyK2zZfsbLtrz/pPnix5CbEImM88s4HHxDFEHBcINg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPhp.min.js" integrity="sha512-K28WfzDb5L7eD+qiTCY0LAKXcPEeYEYdvxuKz1Yn2XNm28aXBxck3wbfYsM/EJDcXl62Aq68ZoN7zcYrbrRcpA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shAutoloader.min.js" integrity="sha512-fgB2B2iNPSMDR0e4sUBX9rVPhScqSJlamsQBhe+1CI+TbvoBL0N7hmlpOGwmO4gr5T0ho+JN0EP8J6JjzHuq/w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPowerShell.min.js" integrity="sha512-Nz643z7l3IUBhaSUHTgkBLxiU+GaIRMiqgUxDy2FjH0DIXEXb2u6QAV8OCZflMfROu+pg6ePw0Uvsemavsf3Ag==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        SyntaxHighlighter.all(); 
    </script>
    <style></style>
    <!-- MathJax 3.2 config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/cancel', '[tex]/physics']
            },
            tex: {
                packages: {
                    '[+]': ['cancel',]
                },
                macros: {
                    shaded: ["{\\bbox[5pt,background-color:##F7F7D2]{#1}}", 1],
                },
                tags: 'all',
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body><div class="entry-content" style="margin: 40px">
<h1>Interface</h1>

<p>
    The <code>interface</code> image makes the device an "OPNpool Interface". Besides monitoring the pool controller and providing access to a web interface, it provides automatic updates, network discovery and supports post mortem debugging.
</p>
<p>
    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/architecture-copy-1.svg">
                <img src="https://coertvonk.com/wp-content/uploads/architecture-copy-1.svg" alt="" width="525" height="525" class="alignnone size-large wp-image-32094" />
            </a>
            <figcaption>
                Architecture
            </figcaption>
        </figure>
    </div>
</p>
<p>
    The entry point of the code is <code>app_main()</code> in the file <code>main/main.c</code>.
</p>
<p>
    <code>app_main()</code> starts by initializing devices and connecting to the WiFi network. The interface appplication is split over different tasks that communicate over message queues offered by the <a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/system/freertos.html">Free Real Time Operating System</a>  (Freitas).
    <ul>
        <li>
            <code>factory_reset_task</code>
        </li>
        <li>
            <code>pool_task</code>
        </li>
        <li>
            <code>ota_update_task</code>
        </li>
        <li>
            <code>http server</code>
        </li>
        <li>
            <code>mqtt_task</code>
        </li>
        <li>
            <code>hass_task</code>
        </li>
    </ul>
</p>

<!------------------>

<h2>
    factory_reset_task
</h2>
<p>
    A factory reset erases the Wifi credentials and returns to the <code>factory</code> app. This allows the device to be provisioned from scratch. To perform a Factory Reset, pull <code>GPIO#0</code> low for five seconds, while the <code>interface</code> app is running (not during boot up). The development board, has a <code>boot</code> button) that services the same function.  I

    <div class="flex-container tight">
        <figure>
            [code toolbar="false" language="plain"]
                I (753) factory_reset_task: Waiting for 3 sec BOOT/RESET press ..
                W (26408) factory_reset_task: Factory reset ..
            [/code]
            <figcaption>
                Device debug trace
            </figcaption>
        </figure>
    </div>
</p>
<p>
    The code base uses the git submodule <a href="https://github.com/cvonk/ESP32_factory-reset-task">ESP32_factory-reset-task</a>.
</p>

<!------------------>

<h2>
    pool_task
</h2>
<p>
    The <code>pool_task</code> forms the heart of OPNpool. It handles data received from the pool controller, and can send requests to the pool controller.
</p>
<p>
    Its responsibilities are:
    <ul>
        <li>
            Initially, it queues a few messages that request thermostat and scheduling information from the pool controller.
        </li>
        <li>
            If it receives a message in the <code>to_pool_q</code>, it creates a corresponding network message. It then calls <code>datalink_tx_pkt_queue</code> to add the preamble and tail, and queues it for transmission through the rs485 driver.
        </li>
        <li>
            Reads bytes from the rs485 driver to create a data packet. It passes this up the stack create a network message. Based on that it updates the pool state information and publishes it using the MQTT task.
        </li>
    </ul>
</p>
<p>
    The protocol stack is shown in the illustration below.
    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/pool_task-copy.svg">
                <img src="https://coertvonk.com/wp-content/uploads/pool_task-copy.svg" alt="" width="300" class="alignnone size-large wp-image-32093" />
            </a>
            <figcaption>
                Pool task layers
            </figcaption>
        </figure>
    </div>
</p>
<p>
    The following sections provide more information about the protocol stack.
</p>

<h3>
    RS-485 driver
</h3>
<p>
    Starting from the physical RS-485 bus, the signal passes through the MAX3485 transceiver that connects to the RX, TX and RTS pins of the ESP32 UART. This UART presents the signal as bytes to the driver.
</p>
<p>
    The driver:
    <ul>
        <li>
            Initializes the UART.
        </li>
        <li>
            Provides functions to read and write bytes.
        </li>
        <li>
            Bytes to be transmitted are queued as as <code>rs485_q_msg</code> in <code>rs485->tx_q</code>. When a transmit opportunity arrises, the <code>pool_task</code> dequeues from <code>rs485->tx_q</code>, relies on the driver to transmits the bytes.
        </li>
    </ul>    
</p>
<p>
    Transmitting on the RS-485 is a bit tricky because it operates in half-duplex and has multiple nodes on the same single twisted pair. In practice, the pool controller appears to only accept messages after it broadcasts its periodic status message, and before it communicates with the chlorinator. Therefore, outgoing bytes are queued, until the moment arrives where they can be transmitted
</p>
<p>
    It communicates with the datalink layer using the <code>rs485_handle_t</code> device handle.

    [code toolbar="false" language="c"]
        typedef struct rs485_instance_t {
            rs485_available_fnc_t available;      // bytes available in rx buffer
            rs485_read_bytes_fnc_t read_bytes;    // read bytes from rx buffer
            rs485_write_bytes_fnc_t write_bytes;  // write bytes to tx buffer 
            rs485_flush_fnc_t flush;              // wait until all bytes are transmitted
            rx485_tx_mode_fnc_t tx_mode;          // controls RTS pin (for half-duplex)
            rs485_queue_fnc_t queue;              // queue to handle->tx_q
            rs485_dequeue_fnc_t dequeue;          // dequeue from handle->tx_q
            QueueHandle_t tx_q;                   // transmit queue
        } rs485_instance_t;
        typedef struct rs485_instance_t * rs485_handle_t;
    [/code]    
</p>

<h3>
    Datalink layer
</h3>
<p>
    Provides framing and byte error detection. The interface with the network layers is through <code>datalink_pkt_t</code>.
</p>
<p>
    It supports both the A5 and IC protocol.
</p>
<p>
    It communicates with the network layer using the <code>datalink_pkt_t</code> structure.

    [code toolbar="false" language="c"]
        typedef struct datalink_pkt_t {
            datalink_prot_t    prot;      // datalink_prot as detected by `_read_head`
            uint8_t            prot_typ;  // from datalink_hdr_a5->typ
            uint8_t            src;       // from datalink_hdr_a5->src
            uint8_t            dst;       // from datalink_hdr_a5->dst
            datalink_data_t *  data;
            size_t             data_len;
            skb_handle_t       skb;
        } datalink_pkt_t;
    [/code]   
</p>
<p>
    Its functions are:
    <ul>
        <li>
            <code>datalink_rx_pkt()</code>, receives bytes from the RS-485 bus and makes a  <code>datalink_pkt</code> from it. It is implemented as a state machine, using socket buffers to store the bytes received.
        </li>
        <li>
            <code> datalink_tx_pkt()</code>, receives a <code>datalink_pkt</code> and wraps it with a header and tailer. It then queues it for transmission on the RS-485 bus. Once there is a transmit opportunity, the <code>pool_task</code> send it using the rs485 driver.
        </li>
    </ul>
</p>

<h3>
    Network layer
</h3>
<p>
    This layer translates between <code>datalink_pkt</code> and the protocol-agnostic <code>network_msg</code>.
</p>
<p>
    It communicates with the `poolstate` layer using the <code>network_msg_t</code> structure.

    [code toolbar="false" language="c"]
        typedef struct network_msg_t {
            network_msg_typ_t typ;
            union {
                network_msg_pump_reg_set_t * pump_reg_set;
                network_msg_pump_reg_resp_t * pump_reg_set_resp;
                network_msg_pump_ctrl_t * pump_ctrl;
                network_msg_pump_mode_t * pump_mode;
                network_msg_pump_run_t * pump_run;
                network_msg_pump_status_resp_t * pump_status_resp;
                network_msg_ctrl_set_ack_t * ctrl_set_ack;
                network_msg_ctrl_circuit_set_t * ctrl_circuit_set;
                network_msg_ctrl_sched_resp_t * ctrl_sched_resp;
                network_msg_ctrl_state_t * ctrl_state;
                network_msg_ctrl_time_t * ctrl_time;
                network_msg_ctrl_heat_t * ctrl_heat;
                network_msg_ctrl_heat_set_t * ctrl_heat_set;
                network_msg_ctrl_layout_t * ctrl_layout;
                network_msg_ctrl_layout_set_t * ctrl_layout_set;
                network_msg_chlor_ping_req_t * chlor_ping_req;
                network_msg_chlor_ping_resp_t * chlor_ping;
                network_msg_chlor_name_t * chlor_name;
                network_msg_chlor_level_set_t * chlor_level_set;
                network_msg_chlor_level_resp_t * chlor_level_resp;
                uint8_t * bytes;
            } u;
        } network_msg_t;
    [/code]
</p>
<p>
    Its public functions are:
    <ul>
        <li>
            <code>network_rx_msg()</code>, translates a <code>datalink_pkt</code> writes it as <code>network_msg</code>.
        </li>
        <li>
            <code>network_create_msg()</code>, creates a <code>datalink_pkt</code> from a <code>network_msg</code>.
        </li>
    </ul>
</p>

<h3>
    Poolstate
</h3>
<p>
    The <code>sysState_t</code> structure stores the state of the pool system. It is updated based on status messages from the controller, and by querying the controller. Once the controller replied to these queries, <code>pool()</code> starts honoring commands from the Serial port connected to the computer.
</p>

<h3>
    ota_update_task
</h3>
<p>
    This is the same git submodule that we used for <a href="#ota">Factory application</a> earlier.
</p>
<p>
    Each time the device powers up, it checks to see if an new <code>interface</code> app is available. If so, it will download the image and switches to the new version. [<a href="https://github.com/espressif/esp-idf/tree/master/examples/system/ota">doc</a>]  To trigger an OTA update, power cycle the device, or press the <code>EN</code> button.
</p>
<p>
    When the new <code>interface</code> app has critical errors, a rollback mechanism keep the device working by automatically rolling back to the previous working application. 
</p>
<p>
    After the app is downloaded using OTA, it is marked as <code>pending_verify</code>. Once the application determines that it is working well, it marks it as <code>valid</code>. On the other hand, when the application marks it as <code>invalid</code> or the device resets, the bootloader will boot the previous working application. [<a href="https://docs.espressif.com/projects/esp-idf/en/latest/api-reference/system/ota.html">doc</a>]
</p>

<h3>
    http server
</h3>
<p>
    Albeit not technically a task, we'll discuss it here.
</p>
<p>
    The HTTP server provides an UI to see the pool state and control a few settings.
</p>
<p>
    The <code>main_task</code> uses the git module <a href="https://github.com/cvonk/ESP32_wifi-connect">wifi_connect</a> to establish a connection to the WiFi access point. Once established, it calls <code>httpd_register_handlers</code> to register the URI handlers for incoming GET requests.
</p>
<p>
    These handlers are:
    <ul>
        <li>
            <code>httpd_root</code>, replies to <code>GET /</code>
        </li>
        <li>
            <code>httpd_ico</code>", replies to <code>GET /favicon.ico</code>
        </li>
        <li>
            <code>httpd_json</code>, replies to <code>GET /json</code>
        </li>
    </ul>
</p>

<h3>
    httpd_root()
</h3>
<p>
    To save memory space on the ESP32, the device returns a minimum HTML page. The body part is replaced by the <code>replace_body.js</code> script.
</p>
<h3>
    httpd_ico()
</h3>
<p>
    The browser places the favicon next to the page's title on the tab. This function simply sends an HTTP response containing the favicon.
</p>

<h3>
    httpd_json()
</h4>
<p>
    The Arduino replies to <em>any</em> command with the pool state information formatted as JSON. See illustration further down.
<p>
    If query variables were passed, they will be send to the <code>ipc->to_pool_q</code>. The <code>pool_task</code> will create a corresponding message and send it to the pool controller.
</p>
<p>
    The following query variables are supported:

    [code toolbar="false" language="bash"]
        homeassistant/switch/opnpool/pool_circuit/set
        homeassistant/switch/opnpool/spa_circuit/set
        homeassistant/switch/opnpool/aux1_circuit/set
        homeassistant/switch/opnpool/aux2_circuit/set
        homeassistant/switch/opnpool/aux3_circuit/set
        homeassistant/switch/opnpool/ft1_circuit/set
        homeassistant/switch/opnpool/ft2_circuit/set
        homeassistant/switch/opnpool/ft3_circuit/set
        homeassistant/switch/opnpool/ft4_circuit/set
        homeassistant/climate/opnpool/pool_heater/set_mode
        homeassistant/climate/opnpool/pool_heater/set_tmp
        homeassistant/climate/opnpool/spa_heater/set_mode
        homeassistant/climate/opnpool/spa_heater/set_tmp
    [/code]
</p>
<p>
    For the switches, it supports the values <code>ON</code> and <code>OFF</code>. For a thermostat (climate) mode, it supports the values <code>off</code>, <code>heat</code>, <code>solar_pref</code> and <code>solar</code>. For the thermostat temperature it accept a value in Fahrenheit.
</p>
<p>
    Example

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/json-req.png">
                <img src="https://coertvonk.com/wp-content/uploads/json-req-1024x420.png" alt="" width="300" class="alignnone size-large wp-image-31941" />
            </a>
            <figcaption>
                <code>GET /json</code> request
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/json-resp.png">
                <img src="https://coertvonk.com/wp-content/uploads/json-resp-1024x895.png" alt="" width="300" class="alignnone size-large wp-image-31942" />
            </a>
            <figcaption>
                <code>GET /json</code> response
            </figcaption>
        </figure>
    </div>
</p>
<p>
    For details on web integration, refer to the <a href="https://coertvonk.com/sw/pool-interface/web-ui-32000">Web UI section</a>.
</p>
<h3>
    mqtt_task    
</h3>
<p>
    IBM's MQ telemetry transport (MQTT) is a lightweight, publish-subscribe network protocol that transports messages between devices. The keyword is telemetry, or remote monitoring.
</p>
<p>    
    MQTT is rapidly becoming the prevailed protocols to connect large numbers of devices. The <code>mqtt_task</code> implements an MQTT client.
<p>
<p>
    Responsibilities of the task:
    <ul>
        <li>
            Connect to MQTT broker.
        </li>
        <li>
            Initially, check if there is a coredump in flash memory, then publish it to MQTT.
        </li>
        <li>
            Subscribe to control topics, for diagnostic commands.
        </li>
        <li>
            Subscribing or publishing on MQTT topics on behalf of other processes.
        </li>
    </ul>
</ul>
</p>

<h3>
    Connect to MQTT broker
</h3>
<p>
    The code calls <code>esp_mqtt_client_init</code> and waits until the MQTT connection with the broker is established. It learns about a successful connection when it the callback function receives a <code>MQTT_EVENT_CONNECTED</code>.
</p>
<p>
    If the connection were to be broken, the ESP IDF SDK will automatically reconnect to the broker.
</p>

<h3 id="coredump">
    Coredump to MQTT
</h3>
<p>
    As the devices that are deployed in the field, they have no serial monitor connected. Instead, we configure the <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/core_dump.html">ESP-IDF</a> so the coredump is written to flash memory. Next time the ESP32 boots up, and it finds a coredump in flash, it uses the git submodule <a href="https://github.com/cvonk/ESP32_coredump-to-server"><code>ESP32_coredump-to-server</code></a> to publish the coredump to MQTT under the topic <code>opnpool/data/coredump/ID</code>.
</p>

<h3>
    Subscribe to control topics
</h3>
<p>
<p>
    Initially, the device asks MQTT task to subscribe to the topics listed below. Here <code>ID</code> is an unique device identifier.

    [code toolbar="false" language="bash"]
        opnpool/ctrl
        opnpool/ctrl/ID
    [/code]
</p>
<p>
    When another devices publishes a message on these topics, the MQTT task will handle the message. It supports the following values:
    <ul>
        <li><code>who</code>, request device info such as device id, firmware version, WiFi details, MQTT details and heap</li>
        <li><code>restart</code>, restarts the device</li>
        <li><code>htstart</code>, starts heap trace (when enabled)</li>
        <li><code>htstop</code>, stops heap trace (when enabled)</li>
    </ul>
</p>
<p>
    When the MQTT task receives a message on these topics, it will take action and publish a reply to <code>pool/data/ID/</code> as shown below.

    <div class="flex-container tight">
        <figure>            
            <a href="https://coertvonk.com/wp-content/uploads/mqtt-who-publish.png">
                <img src="https://coertvonk.com/wp-content/uploads/mqtt-who-publish.png" alt="" width="300" height="510" class="alignnone size-full wp-image-31944" />
            </a>
            <figcaption>
                Publish "who" to "opnpool/ctrl"
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/mqtt-who-sub.png">
                <img src="https://coertvonk.com/wp-content/uploads/mqtt-who-sub.png" alt="" width="300" height="233" class="alignnone size-large wp-image-31945" />
            </a>
            <figcaption>
                Response of publishing "who" to "opnpool/ctrl"
            </figcaption>
        </figure>
    </div>

</p>

<h3>
    Subscribe/publish on behalf of others
</h3>
<p>
    The <code>hass_task</code> queues a message to <code>ipc->to_mqtt_q</code> in order to subscribe or publish on a topic. The <code>mqtt_task</code> forwards this request to the ESP-IDF SDK.
</p>
<p>
    When subscribing, the topic is also added to the <code>_subscribers</code> list, in case the connection with the broker needs to get re-established.
</p>
<p>
    When another MQTT client publishes on a topic that another process subscribed to, the message is forwarded to the <code>ipc->to_pool_q</code>.
</p>

<!------------------>

<h2>
    hass_task
</h2>
<p>
    Home Assistant is an open source home automation that puts local control and privacy first. 
</p>
<p>
    The hass_task's duties are
    <ul>
        <li>
            Listen for commands over MQTT.
        </li>
        <li>
            Support MQTT device discovery.
        </li>
    </ul>
</p>

<h3>
    Listen for commands over MQTT
</h3>
<p>
    Initially, the device subscribes to the MQTT topics that lets other MQTT clients change pool controller settings such as thermostat set point or heating mode.
</p>
<p>
    It subscribes to the topics listed below.

    [code toolbar="false" language="bash"]
        homeassistant/switch/opnpool/pool_circuit/set
        homeassistant/switch/opnpool/spa_circuit/set
        homeassistant/switch/opnpool/aux1_circuit/set
        homeassistant/switch/opnpool/aux2_circuit/set
        homeassistant/switch/opnpool/aux3_circuit/set
        homeassistant/switch/opnpool/ft1_circuit/set
        homeassistant/switch/opnpool/ft2_circuit/set
        homeassistant/switch/opnpool/ft3_circuit/set
        homeassistant/switch/opnpool/ft4_circuit/set
        homeassistant/climate/opnpool/pool_heater/set_mode
        homeassistant/climate/opnpool/pool_heater/set_tmp
        homeassistant/climate/opnpool/spa_heater/set_mode
        homeassistant/climate/opnpool/spa_heater/set_tmp
    [/code]
</p>
<p>
    When another devices publishes a message on these topics, the MQTT task will forward forward it as a network message to the Pool task. The latter will call <code>hass_tx_pair</code> to handle the message.
</p>
<p>
    For the switches, it supports the values <code>ON</code> and <code>OFF</code>. For a thermostat (climate) mode, it supports the values <code>off</code>, <code>heat</code>, <code>solar_pref</code> and <code>solar</code>. For the thermostat temperature it accept a value in Fahrenheit.
</p>

<h3>
    MQTT device discovery
</h3>
<p>
    We auto populate the Home Assistant entities using <a href="https://www.home-assistant.io/docs/mqtt/discovery/">MQTT Device Discovery</a>. This enables us to use MQTT devices with only minimal configuration effort on the side of Home Assistant.
</p>
<p>
    Every five minute, the device publishes MQTT discovery messages, to announce its presence to Home Assistant.
</p>
<p>
    Some examples of these configuration topics are:

    <div class="flex-container">
        <figure>
            [code toolbar="false" language="JavaScript"]
                topic = homeassistant/sensor/opnpool/air_temp/config;
                value = {
                    "~": "homeassistant/sensor/opnpool/air_temp",
                    "name": "Pool air temp",
                    "stat_t": "~/state",
                    "unit_of_meas": "°F"
                }
            [/code]
        <figcaption>
            Discovery example 1
        </figcaption>
    <figure>
        [code toolbar="false" language="JavaScript"]
            topic = homeassistant/climate/opnpool/pool_heater/config;
            value = {
                "~": "homeassistant/climate/opnpool/pool_heater",
                "name": "Pool pool heater",
                "mode_cmd_t": "~/set_mode",
                "temp_cmd_t": "~/set_temp",
                "mode_stat_tpl": "{{ value_json.mode }}",
                "mode_stat_t": "~/state",
                "temp_stat_tpl": "{{ value_json.target_temp }}",
                "temp_stat_t": "~/state",
                "curr_temp_t": "~/state",
                "curr_temp_tpl": "{{ value_json.current_temp }}",
                "min_temp": 15,
                "max_temp": 110,
                "temp_step": 1,
                "temp_unit": "F",
                "avty_t": "~/available",
                "pl_avail": "online",
                "pl_not_avail": "offline",
                "modes": ["off","heat"]
            }
        [/code]
        <figcaption>
            Discovery example 2
        </figcaption>
    </figure>
    </div>
</p>
<p>
    For details on Home Assistant integration, refer to the <a href="https://coertvonk.com/sw/pool-interface/home-assistant-ui-32008">corresponding chapter</a>.
</p>
<p>
    From there the device publishes the data as e.g.

    [code toolbar="false" language="bash"]homeassistant/sensor/opnpool/air_temp/state 55
homeassistant/climate/opnpool/pool_heater/state {"mode":"off","target_temp":0,"current_temp":0}
homeassistant/climate/opnpool/pool_heater/available online[/code]
</p>
<p>
    <div class="continue-container no-print">
        <div class="continue-content">
            <div class="continue-text">
                Continue reading to learn about the <a href="https://coertvonk.com/sw/pool-interface/web-ui-32000">Web UI</a>.
            </div>
        </div>
    </div>    
</p>
                                            
</div></body>