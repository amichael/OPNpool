<!DOCTYPE html>
<html lang="en-US" class="no-js no-svg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' id='parent-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-fonts-css'
        href='https://fonts.googleapis.com/css?family=Libre+Franklin%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C800%2C800i&#038;subset=latin%2Clatin-ext&#038;display=fallback'
        media='all' />
    <link rel='stylesheet' id='twentyseventeen-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen-child-cvonk/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-block-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/assets/css/blocks.css' media='all' />
    <link rel='stylesheet' id='fancybox-css'
        href='https://coertvonk.com/wp-content/plugins/easy-fancybox/css/jquery.fancybox.min.css' media='screen' />
    <style id='fancybox-inline-css'>
        #fancybox-content {
            border-color: #fff;
        }
    </style>
    <!-- MathJax 3.2 config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/cancel', '[tex]/physics']
            },
            tex: {
                packages: {
                    '[+]': ['cancel',]
                },
                macros: {
                    shaded: ["{\\bbox[5pt,background-color:##F7F7D2]{#1}}", 1],
                },
                tags: 'all',
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript">
        /* <![CDATA[ */
        document.querySelectorAll("ul.nav-menu").forEach(
            ulist => {
                if (ulist.querySelectorAll("li").length == 0) {
                    ulist.style.display = "none";

                }
            }
        );
        /* ]]> */
    </script>
    <style>
        div.flex-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        div.flex-container>* {
            flex-grow: 1;
            max-width: 80%;
        }

        div.flex-container.math>* {
            max-width: 100%;
        }

        div.flex-container.tight>* {
            flex-grow: unset;
            max-width: unset;
        }

        .mathtbl>tbody>tr>td {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
        }

        .mathtbl>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml>tbody>tr>td {
            text-align: center !important;
            border-collapse: collapse;
            border: 1px solid black;
            padding: 0px;
        }

        .mathtblsml>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml {
            font-size: 0.8em;
            margin: auto;
            border-spacing: 0px;
        }

        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }
        }

        .hp41-key {
            font-family: Verdana, Arial, "Times new roman";
            font-size: 10px;
            line-height: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0px 2px;
            color: #000000;
            border: #000000 1px solid;
            border-radius: 3px;
            background-color: #f8f8f8;
        }        
        table.error,
        table.decoded,
        table.partition {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.error tr > th,
        table.error tr > td,
        table.decoded tr > th,
        table.decoded tr > td,
        table.partition tr > th,
        table.partition th > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: wrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.error tr > th,
        table.decoded tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.error tr > *:nth-last-child(2),
        table.decoded tr > *:nth-last-child(2),
        table.partition tr > *:first-child {
            border-right: 1px solid black;
        }

        table.connections,
        table.partition {
            margin: 0 auto;
            margin-top: 1em;
        }
        table.bom {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.connections tr > th,
        table.connections tr > td,
        table.bom tr > th,
        table.bom tr > td,
        table.partition tr > th,
        table.partition tr > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.connections tr > td {
            text-align: center;
        }
        table.partition tr > td {
            text-align: left;
        }
        table.connections tr > th,
        table.bom tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.connections tr > .borderright,
        table.connections tr > *:nth-last-child(4),
        table.connections tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(3) {
            border-right: 1px solid black;
        }

    </style>
</head>

<body><div class="entry-content" style="margin: 40px">
<h1>Web UI</h1>

<p>
    When the OPNpool device connects to the WiFi access point, it will be assigned an IP address. Only the access point and the device know this address. Other hosts can access the device by its mDNS name <code>opnpool.local</code>. 
</p>
<p>
    This relies on service auto-discovery using the Multicast DNS (mDNS) protocol. Note that mDNS's use of multicast packets is designed to work within a single IP subnet. That implies that in general your computer/phone need to be on the same subnet as the OPNpool device for the mDNS protocol to work.
</p>

<h2>
    HTML
</h2>
<p>
    As you may have seem in the video in the Deploying chapter, the OPNpool device can be controlled through a simple HTML UI. This allows the user to monitor the state of the pool controller, pump and chlorinator.
</p>
<p>
    This UI is accessed through the URL <code>http://opnpool.local/</code>. The unsecure connection implies that security solently relies on your WiFi credentials. If you want to access the device from the public internet, I urge you by tunneling into your LAN instead of simply opening a port on your router.
</p>
<p>
    To conserve memory, the OPNpool device only contains the minimum HTML code that refers to an external site for the Stylesheet and the replacement <code>&lt;BODY&gt;</code> element that refers to the JavaScript.
</p>
<p>
    <details>
        <summary>
            Notes on going dark
        </summary>
        <div style="margin-left: 2em; color: grey;">
            To switch to a dark theme:
            <ul>
                <li>
                    Change <code>data-theme="a" data-content-theme="a"</code> to <code>data-theme="b" data-content-theme="b"</code> in <code>replace-body.js</code>, and
                </li>
                <li>
                    Change <code>.rs-bg-color</code> from <code>white</code> to <code>#2b2b2b</code> in <code>index.css</code>.
                </li>
            </ul>
            
            
            <code>data-theme</code> in the HTML <code>&lt;BODY&gt;</code>, and 
    </details>
</p>
<p>
    Some examples of the UI are shown below

    <div class="flex-container tight">
        <figure>            
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-circuits-pool.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-circuits-pool-1.png" alt="" width="300" class="alignnone size-large wp-image-32132" style="filter: drop-shadow(0 0 0.1rem #54BBE0);" /></a>
            <figcaption>
                Request activate Pool circuit
            </figcaption>
        </figure>
        <figure>            
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-air-temp.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-air-temp-1.png" alt="" width="300" class="alignnone size-large wp-image-32138" style="filter: drop-shadow(0 0 0.1rem #54BBE0);" style="filter: drop-shadow(0 0 0.1rem #54BBE0);" /></a>
            <figcaption>
                Air temperature
            </figcaption>
        </figure>
        <figure>            
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-pool-therm.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-pool-therm-1.png" alt="" width="300" class="alignnone size-large wp-image-32133" style="filter: drop-shadow(0 0 0.1rem #54BBE0);" /></a>        
            <figcaption>
                Pool thermostat
            </figcaption>
        </figure>
        <figure>            
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-pump-speed.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-pump-speed-1.png" alt="" width="300" class="alignnone size-large wp-image-32134" style="filter: drop-shadow(0 0 0.1rem #54BBE0);" /></a>
            <figcaption>
                Pump speed
            </figcaption>
        </figure>
        <figure>            
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-salt-level.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-salt-level-1.png" alt="" width="300" class="alignnone size-large wp-image-32135" style="filter: drop-shadow(0 0 0.1rem #54BBE0);" /></a>
            <figcaption>
                Salt level
            </figcaption>
        </figure>
        <figure>            
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-schedules.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-web-ui-schedules-1.png" alt="" width="300" height="656" class="alignnone size-large wp-image-32136" style="filter: drop-shadow(0 0 0.1rem #54BBE0);" /></a>
            <figcaption>
                Schedules
            </figcaption>
        </figure>
    </div>    
</p>
<h2>
    JSON
</h2>
<p>
    The raw state of the pool controller is accessible through <code>http://opnpool.local/json</code>. The HTML page uses this internally, but you can also poll this state from home automation systems. However, if your home automation supports MQTT, I suggest using MQTT as described in the Home Assistant chapter.

    <div class="flex-container tight">
        <figure>            
            [code toolbar="false" language="json"]{
                    "system":{
                        "tod":{
                            "time":"09:56",
                            "date":"2022-04-04"
                        },
                        "firmware":"v2.080"
                    },
                    "temps":{
                        "air":66,
                        "solar":80
                    },
                    "thermos":{
                        "pool":{
                            "temp":66,
                            "sp":70,
                            "src":"None",
                            "heating":false
                        },
                        "spa":{
                            "temp":66,
                            "sp":0,
                            "src":"None",
                            "heating":false
                        }
                    },
                    "pump":{
                        "time":"09:55",
                        "mode":"FILTER",
                        "running":true,
                        "state":"OK",
                        "pwr":604,
                        "rpm":2250,
                        "err":0,
                        "timer":0
                    },
                    "chlor":{
                        "name":"Intellichlor--40",
                        "pct":25,
                        "salt":3800,
                        "status":"OK"
                    },
                    "circuits":{
                        "active":{
                            "spa":false,
                            "aux1":false,
                            "aux2":false,
                            "aux3":false,
                            "ft1":false,
                            "pool":true,
                            "ft2":false,
                            "ft3":false,
                            "ft4":false
                        },
                        "delay":{
                            "spa":false,
                            "aux1":false,
                            "aux2":false,
                            "aux3":false,
                            "ft1":false,
                            "pool":false,
                            "ft2":false,
                            "ft3":false,
                            "ft4":false
                        }
                    },
                    "scheds":{
                        "pool":{
                            "start":"08:00",
                            "stop":"10:00"
                        }
                    },
                    "modes":{
                        "service":false,
                        "UNKOWN_01":false,
                        "tempInc":false,
                        "freezeProt":false,
                        "timeout":false
                    }
                }[/code]
            <figcaption>
                Formatted output of <code>http://opnpool.local/json</code>
            </figcaption>
        </figure>
    </div>
</p>
<h2>
    Who
</h2>
<p>
    The IP address of the OPNpool device can be found using the <code>http://opnpool.local/who</code> page. An example is shown in illustration below.

    <div class="flex-container tight">
        <figure>            
            [code toolbar="false" language="json"]{
                "name":"opnpool",
                "firmware":{
                    "version":"interface.v1.2.3",
                    "date":"Apr  3 2022 14:51:15"
                },
                "wifi":{
                    "connect":1,
                    "address":"10.1.1.24",
                    "SSID":"Guest Barn",
                    "RSSI":-30
                },
                "mqtt":{
                    "connect":1
                },
                "mem":{
                    "heap":151084
                }
            }[/code]
            <figcaption>
                Formatted output of <code>http://opnpool.local/who</code>
            </figcaption>
        </figure>
    </div>    
</p>

<p>
    <div class="continue-container no-print">
        <div class="continue-content">
            <div class="continue-text">
                Continue reading to learn about the <a href="https://coertvonk.com/sw/pool-interface/home-assistant-ui-32008">Home Assistant UI</a>.
        </div>
    </div>    
</p>

</div></body>
