<!DOCTYPE html>
<html lang="en-US" class="no-js no-svg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' id='parent-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-fonts-css'
        href='https://fonts.googleapis.com/css?family=Libre+Franklin%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C800%2C800i&#038;subset=latin%2Clatin-ext&#038;display=fallback'
        media='all' />
    <link rel='stylesheet' id='twentyseventeen-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen-child-cvonk/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-block-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/assets/css/blocks.css' media='all' />
    <link rel='stylesheet' id='fancybox-css'
        href='https://coertvonk.com/wp-content/plugins/easy-fancybox/css/jquery.fancybox.min.css' media='screen' />
    <style id='fancybox-inline-css'>
        #fancybox-content {
            border-color: #fff;
        }
    </style>
    <!-- MathJax 3.2 config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/cancel', '[tex]/physics']
            },
            tex: {
                packages: {
                    '[+]': ['cancel',]
                },
                macros: {
                    shaded: ["{\\bbox[5pt,background-color:##F7F7D2]{#1}}", 1],
                },
                tags: 'all',
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript">
        /* <![CDATA[ */
        document.querySelectorAll("ul.nav-menu").forEach(
            ulist => {
                if (ulist.querySelectorAll("li").length == 0) {
                    ulist.style.display = "none";

                }
            }
        );
        /* ]]> */
    </script>
    <style>
        div.flex-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        div.flex-container>* {
            flex-grow: 1;
            max-width: 80%;
        }

        div.flex-container.math>* {
            max-width: 100%;
        }

        div.flex-container.tight>* {
            flex-grow: unset;
            max-width: unset;
        }

        .mathtbl>tbody>tr>td {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
        }

        .mathtbl>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml>tbody>tr>td {
            text-align: center !important;
            border-collapse: collapse;
            border: 1px solid black;
            padding: 0px;
        }

        .mathtblsml>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml {
            font-size: 0.8em;
            margin: auto;
            border-spacing: 0px;
        }

        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }
        }

        .hp41-key {
            font-family: Verdana, Arial, "Times new roman";
            font-size: 10px;
            line-height: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0px 2px;
            color: #000000;
            border: #000000 1px solid;
            border-radius: 3px;
            background-color: #f8f8f8;
        }        
        table.error,
        table.decoded,
        table.partition {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.error tr > th,
        table.error tr > td,
        table.decoded tr > th,
        table.decoded tr > td,
        table.partition tr > th,
        table.partition th > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: wrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.error tr > th,
        table.decoded tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.error tr > *:nth-last-child(2),
        table.decoded tr > *:nth-last-child(2),
        table.partition tr > *:first-child {
            border-right: 1px solid black;
        }

        table.connections,
        table.partition {
            margin: 0 auto;
            margin-top: 1em;
        }
        table.bom {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.connections tr > th,
        table.connections tr > td,
        table.bom tr > th,
        table.bom tr > td,
        table.partition tr > th,
        table.partition tr > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.connections tr > td {
            text-align: center;
        }
        table.partition tr > td {
            text-align: left;
        }
        table.connections tr > th,
        table.bom tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.connections tr > .borderright,
        table.connections tr > *:nth-last-child(4),
        table.connections tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(3) {
            border-right: 1px solid black;
        }

    </style>
</head>

<body><div class="entry-content" style="margin: 40px">
<h1>RS-485 bus</h1>

<p>
    The pool conroller uses a so called RS-485 bus to communicate with devices such as the pump and chlorinator. This is an industry standard two-wire bus with differential signaling. Devices are daisy chained with 120 Ω termination resistors on both ends.
</p>
<p>
    By snooping the traffic on this bus, we can learn about the status of the controller. We can also see the commands that the controller sends to the devices and the responses that it receives.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/Pentair-ctrl-ouside-scaled.jpg"><img src="https://coertvonk.com/wp-content/uploads/Pentair-ctrl-ouside-982x1024.jpg" alt="" width="300" class="alignnone size-large wp-image-31861" /></a>
            <figcaption>
                Opening the pool controller
            </figcaption>
        </figure>
    </div>
</p>

<h2>
    Inside the controller
</h2>
<p>
    The easiest place to access this bus is from inside the pool controller. 
</p>
<p>
    <div class="flex-container tight">
        <p class="important-note" style="width: 80%;">
            <span class="icon" style="font-size: 2rem;">⚠</span>
            PROCEED AT YOUR OWN RISK! At the very least make turn off the power while you work on it. Be careful, THERE IS ALWAYS A RISK OF BREAKING YOUR POOL EQUIPMENT.
        </p>
    </div>
</p>
<p>
    Having said that .. the RS-485 header is on the back of the control board. There are probably already wires connected that go to the devices such as pump and chlorinator.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/Pentair-ctrl-inside-2.jpg"><img src="https://coertvonk.com/wp-content/uploads/Pentair-ctrl-inside-2-1024x1024.jpg" alt="" width="200" class="alignnone size-large wp-image-31859" /></a>
            <figcaption>
                Inside of controller
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/Pentair-ctrl-inside-connector-scaled.jpg"><img src="https://coertvonk.com/wp-content/uploads/Pentair-ctrl-inside-connector-1024x1024.jpg" alt="" width="200" class="alignnone size-large wp-image-31860" /></a>
            <figcaption>
                Inside of controller connector removed
            </figcaption>
        </figure>
    </div>
</p>
<p>
    To minimize electromagnetic interference, use two twisted pairs from e.g. CAT-5 cable to connect the <code>A</code>/<code>B</code> pair and the <code>+15V</code>/<code>GND</code> power pair to our interface as shown in the table below. To minimize the risk of shorting the power, you probably don't want to connect the power signal yet.

    <div>
        <div class="flow-container">
            <table class="connections">
                <tr>
                    <th colspan="2" class="borderright">Controller</th>
                    <th colspan="2">RS-485</th>
                    <th>Cat5</th>
                </tr>
                <tr>
                    <th>Com Port</th>
                    <th>Name</th>
                    <th>Name</th>
                    <th>Idle state</th>
                    <th>wire pair</th>
                </tr>
                <tr>
                    <td>Green</td>
                    <td><code>-DATA</code></td>
                    <td><code>A</code></td>
                    <td>negative</td>
                    <td>pair 1</td>
                </tr>
                <tr>
                    <td>Yellow</td>
                    <td><code>+DATA</code></td>
                    <td><code>B</code></td>
                    <td>positive</td>
                    <td>pair 1</td>
                </tr>
                <tr>
                    <td>Red</td>
                    <td><code>+15 V</code></td>
                    <td></td>
                    <td>n/a</td>
                    <td>pair 2</td>
                </tr>
                <tr>
                    <td>Black</td>
                    <td><code>GND</code></td>
                    <td></td>
                    <td>n/a</td>
                    <td>pair 2</td>
                </tr>
            </table>
        </div>
    </div>
</p>

<h2>
    RS-485 connection
</h2>
<p>
    With our cable connected, we can examine the signals. The shortest pulse length is about 104 µsec, so that the data rate follows as 1/0.000104 = 9600 baud. This low data rate means that we don't have to be very concerned about daisy chaining the devices. In other words, it is OK to just wiretap the signal on the controller.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-rs485-bitwidth-104usec.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-rs485-bitwidth-104usec.png" alt="" width="320" class="alignnone size-large wp-image-32111" /></a>
            <figcaption>
                1 bit takes &thickapprox;104 µsec 
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-rs485-breakout.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-rs485-breakout.png" alt="" width="320" class="alignnone size-large wp-image-32110" /></a>
            <figcaption>
                <a href="https://www.aliexpress.com/item/4001028673092.html">RS-485 transceiver breakout</a>
            </figcaption>
        </figure>
    </div>
</p>
<p>
    When we connect the differential signal to a RS-485 transceiver such as the MAX485, we get regular TTL levels. Notice the repeating messages every 2 seconds.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-rs485-one-message.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-rs485-one-message.png" alt="" width="320" class="alignnone size-full wp-image-32109" /></a>
            <figcaption>
                Single message
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-rs485-msg-repeats.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-rs485-msg-repeats.png" alt="" width="320" class="alignnone size-full wp-image-32112" /></a>
            <figcaption>
                Messages repeat every 2 sec
            </figcaption>
        </figure>
    </div>
</p>
<p>
    The exact flavor of the data bus is shown below.
    <div class="flow-container tight">
        <table class="connections">
            <tr>
                <th>Name</th>
                <th>Value</th>
            </tr>
            <tr>
                <td>baud rate</td>
                <td>9600</td>
            </tr>
            <tr>
                <td>data bits</td>
                <td>8</td>
            </tr>
            <tr>
                <td>parity</td>
                <td>none</td>
            </tr>
            <tr>
                <td>stop bits</td>
                <td>1</td>
            </tr>
        </table>
    </div>
</p>
<p>
    Now that we know the interface and baud rate, we can move on to building a system that interprets the proprietary message protocol.
</p>

<h2>
    TTL to CMOS signals
</h2>
<p>
    The microcontrollers that we consider use CMOS voltages (3.3 V). For the prototypes, we used an existing breakout board, but replaced the MAX485 with a MAX3485CSA+ chip. While we're at it, we also remove the 10 kΩ CMOS pullup resistors (R1 - R4), but left the RS-485 bias and bus termination resistors.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/RS-485-module-MAX485-schematic.jpg"><img src="https://coertvonk.com/wp-content/uploads/RS-485-module-MAX485-schematic-400x336.jpg" alt="" width="240" class="alignnone size-medium wp-image-31868" /></a>
            <figcaption>
                Breakout schematic<br />Source: <a href="https://arduinoinfo.mywikis.net/wiki/RS485-Modules">yourduino.com</a>
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/RS485-with-new-3V3-part-scaled.jpg"><img src="https://coertvonk.com/wp-content/uploads/RS485-with-new-3V3-part-1024x683.jpg" alt="" width="320" class="alignnone size-large wp-image-31865" /></a>
            <figcaption>
                RS485 with new 3.3V part
            </figcaption>
        </figure>
    </div>
</p>
<p>
    <div class="continue-container no-print">
        <div class="continue-content">
            <div class="continue-text">
                Continue reading to learn about the <a href="https://coertvonk.com/sw/pool-interface/hardware-3-31959">hardware design</a>.
            </div>
        </div>
    </div>    
</p>
        
</div></body>
