<!DOCTYPE html>
<html lang="en-US" class="no-js no-svg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' id='parent-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-fonts-css'
        href='https://fonts.googleapis.com/css?family=Libre+Franklin%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C800%2C800i&#038;subset=latin%2Clatin-ext&#038;display=fallback'
        media='all' />
    <link rel='stylesheet' id='twentyseventeen-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen-child-cvonk/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-block-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/assets/css/blocks.css' media='all' />
    <link rel='stylesheet' id='fancybox-css'
        href='https://coertvonk.com/wp-content/plugins/easy-fancybox/css/jquery.fancybox.min.css' media='screen' />
    <style id='fancybox-inline-css'>
        #fancybox-content {
            border-color: #fff;
        }
    </style>
    <!-- MathJax 3.2 config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/cancel', '[tex]/physics']
            },
            tex: {
                packages: {
                    '[+]': ['cancel',]
                },
                macros: {
                    shaded: ["{\\bbox[5pt,background-color:##F7F7D2]{#1}}", 1],
                },
                tags: 'all',
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript">
        /* <![CDATA[ */
        document.querySelectorAll("ul.nav-menu").forEach(
            ulist => {
                if (ulist.querySelectorAll("li").length == 0) {
                    ulist.style.display = "none";

                }
            }
        );
        /* ]]> */
    </script>
    <style>
        div.flex-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        div.flex-container>* {
            flex-grow: 1;
            max-width: 80%;
        }

        div.flex-container.math>* {
            max-width: 100%;
        }

        div.flex-container.tight>* {
            flex-grow: unset;
            max-width: unset;
        }

        .mathtbl>tbody>tr>td {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
        }

        .mathtbl>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml>tbody>tr>td {
            text-align: center !important;
            border-collapse: collapse;
            border: 1px solid black;
            padding: 0px;
        }

        .mathtblsml>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml {
            font-size: 0.8em;
            margin: auto;
            border-spacing: 0px;
        }

        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }
        }

        .hp41-key {
            font-family: Verdana, Arial, "Times new roman";
            font-size: 10px;
            line-height: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0px 2px;
            color: #000000;
            border: #000000 1px solid;
            border-radius: 3px;
            background-color: #f8f8f8;
        }        
        table.error,
        table.decoded,
        table.partition {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.error tr > th,
        table.error tr > td,
        table.decoded tr > th,
        table.decoded tr > td,
        table.partition tr > th,
        table.partition th > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: wrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.error tr > th,
        table.decoded tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.error tr > *:nth-last-child(2),
        table.decoded tr > *:nth-last-child(2),
        table.partition tr > *:first-child {
            border-right: 1px solid black;
        }

        table.connections,
        table.partition {
            margin: 0 auto;
            margin-top: 1em;
        }
        table.bom {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.connections tr > th,
        table.connections tr > td,
        table.bom tr > th,
        table.bom tr > td,
        table.partition tr > th,
        table.partition tr > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.connections tr > td {
            text-align: center;
        }
        table.partition tr > td {
            text-align: left;
        }
        table.connections tr > th,
        table.bom tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.connections tr > .borderright,
        table.connections tr > *:nth-last-child(4),
        table.connections tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(3) {
            border-right: 1px solid black;
        }

    </style>
</head>

<body><div class="entry-content" style="margin: 40px">
<h1>Hardware</h1>

<p>
    The OPNpool hardware design is based around a RS-485 Transceiver and an ESP32 System on a Chip (SoC). The transceiver converts between the RS-485 differential signals and the transmit/receive signals used by the UART in the SoC. The ESP32 is supported by the well documented Espressif IoT Development Framework (ESP-IDF).
</p>

<h2>
    Early prototypes
</h2>
<p>
    We started with a single threaded task on a Espressif ESP8266 SoC. It was cheap and offered build-in WiFi. Over time, we migrated to the newer ESP32. Still very affordable, and it offers Bluetooth LE and runs FreeRTOS what helped in separating the software components.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hardware-proto1.jpg"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hardware-proto1-1024x715.jpg" alt="" width="300" class="alignnone size-large wp-image-32116" /></a>
            <figcaption>
                1st prototype based on ESP8266,<br />with two RS-232 and a RS485 transceiver.
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hardware-proto2.jpg"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hardware-proto2-1024x785.jpg" alt="" width="300" class="alignnone size-large wp-image-32117" /></a>
            <figcaption>
                2nd prototype based on ESP8266,<br />with RS-232 and RS-485 transceivers.
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hardware-proto3.jpg"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hardware-proto3-1024x892.jpg" alt="" width="220" class="alignnone size-large wp-image-32118" /></a>
            <figcaption>
                3rd prototype based on ESP32<br />with RS-485 transceiver.
            </figcaption>
        </figure>
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hardware-proto4.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hardware-proto4-1024x476.png" alt="" width="400" class="alignnone size-large wp-image-32119" /></a>
            <figcaption>
                4th prototype based on ESP32 development board<br />with RS-485 transceiver.
            </figcaption>
        </figure>
    </div>
</p>

<h2>
    ESP32 SoC
</h2>
<p>
    The ESP32 SoC combines two 32-bit 340 MHz microcontrollers, one LPU microcontroller, various peripherals such as WiFi, Bluetooth LE with 4 MByte Flash and 512 MByte SRAM.
</p>
<p>
    Instead of doing the reset logic and adding an USB bridge ourselves, we chose to use a SoC mounted on a Wemos LOLIN D32 daughterboard.
</p>

<h2>
    Schematic
</h2>
<p>    
    The schematic is pretty straightforward.  We take the power from the pool controller and convert it to 3.3 V.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hardware-schematic-power.svg"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hardware-schematic-power.svg" alt="" width="540" class="alignnone size-large wp-image-32123" /></a>
            </a>
            <figcaption>
                Schematic power
            </figcaption>
        </figure>
    </div>
</p>
<p>
    The data path is between the RS-485 connector and the ESP32 on the LOLIN D32 daughterboard.  There is an optional terminator resistor to prevent reflections on the bus. The JTAG header is for debugging as detailed in the Debugging chapter.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hardware-schematic-logic.svg"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hardware-schematic-logic.svg" alt="" width="700" class="alignnone size-large wp-image-32122" /></a>
            <figcaption>
                Schematic logic
            </figcaption>
        </figure>
    </div>
</p>
<p>
    Note to self: when re-spinning the board, add LEDs for <code>3.3 v</code> (red) <code>RX</code> (green) and <code>TX</code> (blue) to simplify setup.  I would also add a push button that pulls <code>GPIO#0</code> to ground for factory reset.
</p>
<h3>
    Bill of Materials
</h3>
<p>
    <div class="flex-container">
        <table class="bom">
            <tr>
                <th width="15%">Name</th>
                <th>Description</th>
                <th>Paid</th>
            </tr>
            <tr>
            <td>LOLIN D32</td>
                <td><a href="https://wiki.wemos.cc/products:d32:d32">Wemos LOLIN D32, based on ESP-WROOM-32 4MB</a></td>
                <td><a href="https://www.aliexpress.com/item/WEMOS-LOLIN32-V1-0-0-wifi-bluetooth-board-based-ESP-32-4MB-FLASH/32808551116.html">$6.50</a></td>
            </tr>
            <tr>
                <td>MAX3485CSA+</td>
                <td>Maxim MAX3485CSA+, RS-485/UART interface IC 3.3V</td>
                <td><a href="http://www.mouser.com/ProductDetail/Maxim-Integrated/MAX3485CSA+/">$2.89</a></td>
            </tr>
            <tr>
                <td>DC1</td>
                <td>DC/DC Converter R-78E5.0-0.5, 5V, 0.5A</td>
                <td><a href="http://www.mouser.com/ProductDetail/RECOM-Power/R-78E50-05/">$2.70</a></td>
            </tr>
            <tr>
                <td>D2</td>
                <td>Rectron Schottky Diode, 1N5818 (or MBRS130 1A 0.3V SMB)</td>
                <td><a href="https://www.mouser.com/ProductDetail/ON-Semiconductor-Fairchild/SS12">$0.14</a></td>
            </tr>
            <tr>
                <td>C1, C2</td>
                <td>Capacitor, 10 µF, 25 V, multi-layer ceramic, 0805</td>
                <td><a href="https://www.mouser.com/ProductDetail/TDK/C2012X5R1E106K125AB">$0.34</a></td>
            </tr>
            <tr>
                <td>C3</td>
                <td>Capacitor, 0.1 µF, 6.3 V, multi-layer ceramic, 0805</td>
                <td><a href="https://www.mouser.com/ProductDetail/KEMET/C0805C104K9RACTU">$0.22</a></td>
            </tr>
            <tr>
                <td>R1</td>
                <td>Not stuffed, resistor, 120 Ω, 1/4 W, 0805</td>
                <td><a href="https://www.mouser.com/ProductDetail/660-RK73H2ATTD1200F">$0.10</a></td>
            </tr>
            <tr>
                <td>RS485-TERM-5MM</td>
                <td>Fixed terminal block, 4-pin, screwless, 5 mm pitch</td>
                <td><a href="https://www.mouser.com/ProductDetail/Phoenix-Contact/1864451">$1.75</a></td>
            </tr>
            <tr>
                <td>RS485_CONN</td>
                <td>Plug and socket, 5-pin, SD16-5, IP68 waterproof</td>
                <td><a href="https://www.aliexpress.com/item/SD16-16mm-5-Pin-Flange-Waterproof-Aviation-Connector-Plug-Socket-Straight-IP68/32401149735.html">$3.29</td>
            </tr>
            <tr>
                <td>PBC</td>
                <td>Printed circuit board</td>
                <td><a href="https://oshpark.com/home">$9.43</td>
            </tr>
            <tr>
                <td>Enclosure</td>
                <td>150x85x35mm clear waterproof project enclosure</td>
                <td><a href="https://www.dx.com/s/492680">$6.99</a></td>
            </tr>
        </table>
    </div>
</p>

<h2>
    Layout
</h2>
<p>
    The schematic fits easily on a two layer PCB. Note the cut out for the RF antenna.
    
    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-hardware-layout.svg"><img src="https://coertvonk.com/wp-content/uploads/opnpool-hardware-layout.svg" alt="" width="300" class="alignnone size-large wp-image-32115" /></a>
            <figcaption>
                Board layout
            </figcaption>
        </figure>
    </div>
</p>


<h3>
    Order the PCB
</h3>
<p>
    You can use the board file to order the printed circuit board. To simplify the process, you can replicate my order from OSH Park using <a href="https://oshpark.com/shared_projects/CFBihnoN">this link</a>.
</p>    

<h3>
    Assembly
</h3>
<p>
    <div class="video-container">
        <video src="https://coertvonk.com/wp-content/uploads/opnpool-hardware-assembly-700p.mp4" preload="auto" width="700" height="394"></video> 
    </div>
</p>
<p>
    <div class="continue-container no-print">
        <div class="continue-content">
            <div class="continue-text">
                Continue reading to learn about the <a href="https://coertvonk.com/sw/embedded/pool-interface/tools-31961">software development tools</a>.
        </div>
    </div>    
</p>

</div></body>

